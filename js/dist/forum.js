(()=>{var t={n:e=>{var s=e&&e.__esModule?()=>e.default:()=>e;return t.d(s,{a:s}),s},d:(e,s)=>{for(var n in s)t.o(s,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:s[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e);const s=flarum.core.compat["forum/app"];var n=t.n(s);const i=flarum.core.compat["common/Model"];var a=t.n(i);const o=flarum.core.compat["common/models/Discussion"];var r=t.n(o);const l=flarum.core.compat["common/models/Forum"];var c=t.n(l);function u(t,e){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},u(t,e)}function d(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,u(t,e)}var f=function(t){function e(){for(var e,s=arguments.length,n=new Array(s),i=0;i<s;i++)n[i]=arguments[i];return(e=t.call.apply(t,[this].concat(n))||this).content=a().attribute("content"),e.is_suggested=a().attribute("is_suggested"),e.sort=a().attribute("sort"),e.field=a().hasOne("field"),e}return d(e,t),e.prototype.apiEndpoint=function(){return"/litalino/mason/answers"+(this.exists?"/"+this.data.id:"")},e}(a());const h=flarum.core.compat["common/utils/computed"];var p=t.n(h),g=function(t){function e(){for(var e,s=arguments.length,n=new Array(s),i=0;i<s;i++)n[i]=arguments[i];return(e=t.call.apply(t,[this].concat(n))||this).name=a().attribute("name"),e.description=a().attribute("description"),e.min_answers_count=a().attribute("min_answers_count"),e.max_answers_count=a().attribute("max_answers_count"),e.show_when_empty=a().attribute("show_when_empty"),e.user_values_allowed=a().attribute("user_values_allowed"),e.validation=a().attribute("validation"),e.icon=a().attribute("icon"),e.sort=a().attribute("sort"),e.deleted_at=a().attribute("deleted_at",a().transformDate),e.allAnswers=a().hasMany("allAnswers"),e.suggestedAnswers=a().hasMany("suggestedAnswers"),e.required=p()("min_answers_count",(function(t){return t>0})),e.multiple=p()("max_answers_count",(function(t){return t>1})),e}return d(e,t),e.prototype.apiEndpoint=function(){return"/litalino/mason/fields"+(this.exists?"/"+this.data.id:"")},e}(a()),v=function(t){function e(){for(var e,s=arguments.length,n=new Array(s),i=0;i<s;i++)n[i]=arguments[i];return(e=t.call.apply(t,[this].concat(n))||this).tag_name=a().attribute("tag_name"),e.tag_id=a().attribute("tag_id"),e.field_name=a().attribute("field_name"),e.switch=a().attribute("switch"),e}return d(e,t),e.prototype.apiEndpoint=function(){return"/litalino/mason/bytags"+(this.exists?"/"+this.data.id:"")},e}(a());const y=flarum.core.compat["common/extend"],w=flarum.core.compat["common/components/DiscussionComposer"];var b=t.n(w);const A=flarum.core.compat["components/Composer"];var M=t.n(A);const F=flarum.core.compat["common/helpers/icon"];var _=t.n(F);const I=flarum.core.compat["common/utils/ItemList"];var x=t.n(I);const S=flarum.core.compat["common/Component"];var N=t.n(S);const T=flarum.core.compat["common/utils/classList"];var P=t.n(T);function E(t,e){return e||(e="sort"),t.sort((function(t,s){return t[e]()-s[e]()}))}function O(t,e){(null==e||e>t.length)&&(e=t.length);for(var s=0,n=new Array(e);s<e;s++)n[s]=t[s];return n}var q=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var s=e.prototype;return s.view=function(t){var e=t.attrs,s=e.field,i=e.answers,o=e.onchange,r=[];(s.suggestedAnswers()||[]).forEach((function(t){-1!==i.findIndex((function(e){return void 0!==e&&e.id()===t.id()}))&&r.push(t.id())}));var l={field:{data:a().getIdentifier(this.field)}};return m("span",{className:"Select"},m("select",{className:"Select-input FormControl",multiple:s.multiple(),onchange:function(t){for(var e,s=[],i=function(t,e){var s="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(s)return(s=s.call(t)).next.bind(s);if(Array.isArray(t)||(s=function(t,e){if(t){if("string"==typeof t)return O(t,e);var s=Object.prototype.toString.call(t).slice(8,-1);return"Object"===s&&t.constructor&&(s=t.constructor.name),"Map"===s||"Set"===s?Array.from(t):"Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s)?O(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){s&&(t=s);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(t.target.options);!(e=i()).done;){var a=e.value;if(a.selected&&"none"!==a.value){var r=a.value,c=n().store.getById("mason-answers",r);c.data.relationships=l,s.push(c)}}o(s)}},!s.multiple()&&m("option",{value:"none",selected:0===r.length,disabled:s.required(),hidden:this.placeholderHidden(s)},this.selectPlaceholder(s)),E(s.suggestedAnswers()||[]).map((function(t){return m("option",{value:t.id(),selected:-1!==r.indexOf(t.id())},t.content())}))),_()("fas fa-caret-down",{className:"Select-caret"}))},s.placeholderHidden=function(t){return!n().forum.attribute("litalino-mason.labels-as-placeholders")&&t.required()},s.selectPlaceholder=function(t){var e="";return n().forum.attribute("litalino-mason.labels-as-placeholders")&&(e+=t.name(),t.required()&&(e+=" *"),e+=" - "),t.required()?e+=n().translator.trans("litalino-mason.forum.answers.choose-option"):e+=n().translator.trans("litalino-mason.forum.answers.no-option-selected"),e},e}(N()),C=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var s=e.prototype;return s.oninit=function(e){var s=this;t.prototype.oninit.call(this,e),this.field=this.attrs.field,this.answers=this.attrs.answers,this.onchange=this.attrs.onchange,this.inputId="FormControl mason-input-"+this.attrs.inputId,this.content="";var n=[];(n=void 0!==this.answers&&this.answers.filter((function(t){return void 0!==t&&t.field().id()===s.field.id()}))).length&&(this.content=n[0].content())},s.view=function(){var t=this;return m("input",{className:"FormControl",required:this.field.required(),value:this.content,class:this.inputId,oninput:function(e){if(t.content=e.target.value,""===t.content)t.onchange([]);else{var s=n().store.createRecord("mason-answers",{attributes:{content:t.content},relationships:{field:{data:a().getIdentifier(t.field)}}});t.onchange([s])}},placeholder:this.fieldPlaceholder()})},s.fieldPlaceholder=function(){return n().forum.attribute("litalino-mason.labels-as-placeholders")?this.field.name()+(this.field.required()?" *":""):""},e}(N());const j=flarum.core.compat["tags/utils/sortTags"];var D=t.n(j),R=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var s=e.prototype;return s.oninit=function(e){var s=this;t.prototype.oninit.call(this,e),this.tags=n().store.all("tags"),this.selectedTags=[],this.attrs.discussion?(this.tags=this.tags.filter((function(t){return t.canAddToDiscussion()||-1!==s.attrs.discussion.tags().indexOf(t)})),this.selectedTags=this.attrs.discussion.tags()):this.tags=this.tags.filter((function(t){return t.canStartDiscussion()})),this.minPrimary=n().forum.attribute("minPrimaryTags"),this.maxPrimary=n().forum.attribute("maxPrimaryTags"),this.minSecondary=n().forum.attribute("minSecondaryTags"),this.maxSecondary=n().forum.attribute("maxSecondaryTags"),this.maxPrimary<=0&&(this.tags=this.tags.filter((function(t){return!t.isPrimary()}))),this.maxSecondary<=0&&(this.tags=this.tags.filter((function(t){return t.isPrimary()}))),this.tags=D()(this.tags),this.inputUuid=Math.random().toString(36).substring(2)},s.view=function(){var t,e=this;if(this.maxPrimary>1||this.maxSecondary>1)return m("div",{className:"Alert"},n().translator.trans("litalino-mason.forum.tags.inadequate-settings"));var s=this.selectedTags.length?this.selectedTags.sort((function(t){return t.parent()?-1:1}))[0].id():null,i=this.inputUuid,a=this.fieldRequired();return m("div",{className:P()("Mason-Field Form-group",(t={},t["Mason-Field--label-as-placeholder"]=n().forum.attribute("litalino-mason.labels-as-placeholders"),t))},m("label",{for:"fofMason-selectInput-"+i},this.fieldLabel()),m("span",{className:"Select"},m("select",{className:"Select-input FormControl",id:"fofMason-selectInput-"+i,onchange:function(t){var s=t.target.value;if(e.selectedTags=[],"none"!==s){e.selectedTags.push(e.tags.find((function(t){return t.id()===s})));var n=e.selectedTags[0].parent();n&&e.selectedTags.push(n)}e.attrs.onchange(e.selectedTags)}},m("option",{value:"none",selected:0===this.selectedTags.length,disabled:a,hidden:this.placeholderHidden()},this.selectPlaceholder()),this.tags.map((function(t){var e=t.parent();return m("option",{value:t.id(),selected:t.id()===s},(e?e.name()+" | ":"")+t.name())})),","),_()("fas fa-caret-down",{className:"Select-caret"})))},s.fieldRequired=function(){return this.minPrimary>0||this.minSecondary>0},s.fieldLabel=function(){var t=n().forum.attribute("litalino-mason.tags-field-name")||n().translator.trans("litalino-mason.forum.tags.tags-label");return this.fieldRequired()&&(t+=" *"),t},s.placeholderHidden=function(){return!n().forum.attribute("litalino-mason.labels-as-placeholders")&&this.fieldRequired()},s.selectPlaceholder=function(){var t="";return n().forum.attribute("litalino-mason.labels-as-placeholders")&&(t+=this.fieldLabel()+" - "),this.fieldRequired()?t+=n().translator.trans("litalino-mason.forum.answers.choose-option"):t+=n().translator.trans("litalino-mason.forum.answers.no-option-selected"),t},e}(N()),H=function(t){function e(){return t.apply(this,arguments)||this}return d(e,t),e.prototype.view=function(){return m("div",{className:"Mason-Grid-Wrapper"},m("div",{className:"Mason-Grid"},(t=this.attrs.items,e=n().forum.attribute("litalino-mason.column-count"),Array(Math.ceil(t.length/e)).fill(void 0).map((function(s,n){return t.slice(e*n,e+e*n)}))).map((function(t){return m("div",{className:"Mason-Row Form-group"},t.map((function(t){return t})))}))));var t,e},e}(N()),U=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var s=e.prototype;return s.oninit=function(e){var s=this;t.prototype.oninit.call(this,e),this.fields=E(n().store.all("mason-fields")),this.answerToFieldIndex=[],this.fields.forEach((function(t){var e=t.suggestedAnswers();Array.isArray(e)?e.forEach((function(e){s.answerToFieldIndex[e.id()]=t.id()})):console.warn("[mason] Missing suggestedAnswers relationship for field",t)}))},s.view=function(){return m("div",{className:"Mason-Fields Mason-Fields--editor"},this.headItems().toArray(),m(H,{items:this.fieldItems().toArray()}))},s.updateSelection=function(t,e){var s=this,n=this.attrs.answers.filter((function(e){var n=s.answerToFieldIndex[e.id()];return void 0===n?e.field().id()!==t.id():n!==t.id()}));n=n.concat(e),this.attrs.onchange(n)},s.headItems=function(){var t=new(x());return n().forum.attribute("litalino-mason.fields-section-title")&&t.add("title",m("h5",{className:"Mason-Field--title"},n().forum.attribute("litalino-mason.fields-section-title"))),t},s.fieldItems=function(){var t=this,e=new(x());return n().forum.attribute("litalino-mason.tags-as-fields")&&e.add("tags",m(R,{discussion:this.attrs.discussion,onchange:function(e){t.attrs.ontagchange&&t.attrs.ontagchange(e)}})),this.fields.forEach((function(s){var i,a,o={field:s,answers:t.attrs.answers,onchange:function(e){t.updateSelection(s,e)}};a=s.user_values_allowed()?m(C,o):m(q,o),e.add("field-"+s.id(),m("div",{class:P()("Mason-Field Form-group",(i={},i["Mason-Field--label-as-placeholder"]=n().forum.attribute("litalino-mason.labels-as-placeholders"),i))},m("label",null,s.icon()?m("[",null,_()(s.icon())," "):null,s.name(),s.required()?" *":null),a,s.description()?m("div",{className:"helpText"},s.description()):null))})),e},e}(N()),B=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var s=e.prototype;return s.oninit=function(e){var s=this;t.prototype.oninit.call(this,e),this.fields=E(n().store.all("mason-fields")),this.answerToFieldIndex=[],this.fields.forEach((function(t){var e=t.suggestedAnswers();Array.isArray(e)?e.forEach((function(e){s.answerToFieldIndex[e.id()]=t.id()})):console.warn("[mason] Missing suggestedAnswers relationship for field",t)}))},s.view=function(){return m("div",{className:"Mason-Fields Mason-Fields--editor"},this.headItems().toArray(),m(H,{items:this.fieldItems().toArray()}))},s.updateSelection=function(t,e){var s=this,n=this.attrs.answers.filter((function(e){var n=s.answerToFieldIndex[e.id()];return void 0===n?e.field().id()!==t.id():n!==t.id()}));n=n.concat(e),this.attrs.onchange(n)},s.headItems=function(){var t=new(x());return n().forum.attribute("litalino-mason.fields-section-title")&&t.add("title",m("h5",{className:"Mason-Field--title"},n().forum.attribute("litalino-mason.fields-section-title"))),t},s.fieldItems=function(){var t=this,e=new(x());return this.fields.forEach((function(s){var i,a={field:s,bytags:t.attrs.bytags,inputId:s.data.id,answers:t.attrs.answers,onchange:function(e){t.updateSelection(s,e)}};i=s.user_values_allowed()?m(C,a):m(q,a),t.attrs.bytags.forEach((function(t){var a;t==s.data.attributes.name&&e.add("field-"+s.id(),m("div",{class:P()("Mason-Field Form-group",(a={},a["Mason-Field--label-as-placeholder"]=n().forum.attribute("litalino-mason.labels-as-placeholders"),a))},m("label",null,s.icon()?m("[",null,_()(s.icon())," "):null,s.name(),s.required()?" *":null),i,s.description()?m("div",{className:"helpText"},s.description()):null))}))})),e},e}(N()),L=function(t){function e(){return t.apply(this,arguments)||this}return d(e,t),e.prototype.matchTags=function(){for(var t=n().store.all("tags"),e=[],s=n().store.all("mason-bytags"),i=[],a=function(){var n=[],a=[];r=t[o].data.attributes.name;var l={};(i=s.filter((function(t){return t.data.attributes.tag_name==r&&1==t.data.attributes.switch})))[0]&&(i.forEach((function(t){n.push(t.data.attributes.field_name),a.push(t.data.id)})),l={tagName:r,fields:n,fieldIDs:a},e.push(l))},o=0;o<t.length;o++){var r;a()}return e},e}(N());const k=flarum.core.compat["tags/components/TagDiscussionModal"];var $=t.n(k);const G=flarum.core.compat["forum/utils/DiscussionControls"];var z=t.n(G);const J=flarum.core.compat["common/components/Button"];var W=t.n(J);const K=flarum.core.compat["common/components/Modal"];var Q=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.answers=this.attrs.discussion.masonAnswers(),this.dirty=!1,this.processing=!1,this.tagRelationship=this.attrs.discussion.data.relationships.tags.data[0],this.byTagEnabled=n().data.resources[0].attributes["litalino-mason.by-tag"],this.tags=null;var s=(new L).matchTags();this.myFields=[];for(var i=this.attrs.discussion.payload.included.find((function(t){return"tags"==t.type})),a=0;a<s.length;a++)s[a].tagName==i.attributes.name&&(this.myFields=s[a].fields)},s.title=function(){return n().translator.trans("litalino-mason.forum.answers-modal.edit-title",{title:m("em",null,this.attrs.discussion.title())})},s.content=function(){var t=this;return m("[",null,m("div",{className:"Modal-body"},this.byTagEnabled?m(B,{discussion:this.attrs.discussion,answers:this.answers,bytags:this.myFields,tags:this.tags,onchange:this.answersChanged.bind(this)}):m(U,{discussion:this.attrs.discussion,answers:this.answers,onchange:this.answersChanged.bind(this),ontagchange:function(e){t.tags=e,t.dirty=!0}})),m("div",{className:"Modal-footer"},m(W(),{className:"Button Button--primary",loading:this.processing,disabled:!this.dirty,onclick:this.saveAnswers.bind(this)},n().translator.trans("litalino-mason.forum.answers-modal.save"))))},s.answersChanged=function(t){this.answers=t,this.dirty=!0},s.saveAnswers=function(){var t=this;this.processing=!0;var e={tags:[{data:this.tagRelationship}],masonAnswers:this.answers},s=n().store.createRecord("discussions");s.pushData({id:this.attrs.discussion.id()}),s.exists=!0,s.save({relationships:e}).then((function(){t.processing=!1,n().modal.close(),m.redraw()})).catch((function(e){throw t.processing=!1,e}))},e}(t.n(K)());const V=flarum.core.compat["common/components/DiscussionHero"];var X=t.n(V),Y=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.fields=E(n().store.all("mason-fields")),this.discussion=this.attrs.discussion},s.view=function(){var t=this.headItems().toArray(),e=this.fieldsItems().toArray();return e.length||t.length&&!n().forum.attribute("litalino-mason.hide-empty-fields-section")?m("div",{className:"Mason-Fields Mason-Fields--viewer"},t,m(H,{items:e})):m("div",null)},s.headItems=function(){var t=this,e=new(x());return this.discussion.canUpdateMasonAnswers()&&e.add("edit",m(W(),{className:"Button Mason-Fields--edit",icon:"fas fa-pen",onclick:function(){return n().modal.show(Q,{discussion:t.discussion})}},n().translator.trans("litalino-mason.forum.discussion-controls.edit-answers"))),n().forum.attribute("litalino-mason.fields-section-title")&&e.add("title",m("h5",{className:"Mason-Field--title"},n().forum.attribute("litalino-mason.fields-section-title"))),e},s.fieldsItems=function(){var t=this,e=new(x());return this.fields.forEach((function(s){var i=E((t.discussion.masonAnswers()||[]).filter((function(t){return t.field()&&t.field().id()===s.id()}))),a=i.map((function(t){return m("span",{className:"Mason-Inline-Answer"},t.content())}));if(0===i.length){if(!s.show_when_empty())return;a.push(m("em",{className:"Mason-Inline-Answer"},n().translator.trans("litalino-mason.forum.post-answers.no-answer")))}e.add("field-"+s.id(),m("div",{className:"Mason-Field Form-group"},m("label",null,s.icon()?m("[",null,_()(s.icon())," "):null,s.name()),m("div",{className:"FormControl Mason-Inline-Answers"},a)))})),e},e}(N());const Z=flarum.core.compat["common/components/CommentPost"];var tt=t.n(Z);const et=flarum.core.compat["common/components/DiscussionPage"];var st=t.n(et);function nt(t){return!!n().current.matches(st())&&1===t.number()&&!n().forum.attribute("litalino-mason.fields-in-hero")}n().initializers.add("litalino-mason",(function(t){t.store.models["mason-fields"]=g,t.store.models["mason-answers"]=f,t.store.models["mason-bytags"]=v,r().prototype.masonAnswers=a().hasMany("masonAnswers"),r().prototype.canSeeMasonAnswers=a().attribute("canSeeMasonAnswers"),r().prototype.canUpdateMasonAnswers=a().attribute("canUpdateMasonAnswers"),c().prototype.canFillMasonFields=a().attribute("canFillMasonFields"),function(){b().prototype.masonAnswers=[];var t=n().data.resources[0].attributes["litalino-mason.by-tag"],e=new L,s="",i="";(0,y.extend)($().prototype,"onsubmit",(function(t){s=0!=this.selected?this.selected[0].data.attributes.name:""})),(0,y.extend)(M().prototype,"hide",(function(t){s=""})),(0,y.extend)(b().prototype,"headerItems",(function(a){var o=this;if(n().forum.canFillMasonFields()){var r=e.matchTags();if(t){this.myFields=[];for(var l=[],c=0;c<r.length;c++)r[c].tagName==s&&(this.myFields=r[c].fields),l.push(r[c].tagName);i!=s&&(this.composer.fields.masonAnswers=[],i=s);var u=this.composer.fields.tags;if(!Array.isArray(u))return!1;u.some((function(t){l.toString().includes(t.name())&&(t.id()?a.add("mason-fields",m(B,{bytags:o.myFields,tags:o.composer.fields.tags,answers:o.composer.fields.masonAnswers||[],onchange:function(t){o.composer.fields.masonAnswers=t}})):a.add("mason-fields",m(U,{answers:o.composer.fields.masonAnswers||[],onchange:function(t){o.composer.fields.masonAnswers=t},ontagchange:function(t){o.composer.fields.tags=t}})))}))}}})),(0,y.extend)(b().prototype,"data",(function(t){n().forum.canFillMasonFields()&&this.composer.fields.masonAnswers&&(t.relationships=t.relationships||{},t.relationships.masonAnswers=this.composer.fields.masonAnswers)}))}(),(0,y.extend)(X().prototype,"items",(function(t){this.attrs.discussion.canSeeMasonAnswers()&&n().forum.attribute("litalino-mason.fields-in-hero")&&t.add("mason-fields",m(Y,{discussion:this.attrs.discussion}))})),(0,y.override)(M().prototype,"animateToPosition",(function(t,e){var s=this.$().stop(!0),n=s.outerHeight();m.redraw(!0),s.show();var i=this.$(".ComposerBody-header").outerHeight();return e===M().PositionEnum.NORMAL&&n<i&&(this.height=i+n,this.updateHeight()),t(e)})),(0,y.extend)(tt().prototype,"oninit",(function(){var t=this;this.attrs.post.discussion().canSeeMasonAnswers()&&nt(this.attrs.post)&&this.subtree.check((function(){return(t.attrs.post.discussion().masonAnswers()||[]).map((function(t){return t?JSON.stringify([t.id(),!!t.field()]):""})).join(",")}))})),(0,y.extend)(tt().prototype,"content",(function(t){if(this.attrs.post.discussion().canSeeMasonAnswers()&&nt(this.attrs.post)){var e=t.findIndex((function(t){return t.attrs&&"Post-header"===t.attrs.className}));t.splice(-1===e?0:e+1,0,m(Y,{discussion:this.attrs.post.discussion()}))}})),(0,y.extend)(z(),"moderationControls",(function(t,e){e.canUpdateMasonAnswers()&&t.add("mason-update-answers",m(W(),{icon:"fas fa-tag",onclick:function(){return n().modal.show(Q,{discussion:e})}},n().translator.trans("litalino-mason.forum.discussion-controls.edit-answers")))})),(0,y.override)(a(),"getIdentifier",(function(t,e){return e instanceof f&&!e.exists?{type:e.data.type,attributes:{content:e.data.attributes.content},relationships:{field:{data:a().getIdentifier(e.data.relationships.field)}}}:t(e)}))}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map